{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">Register Your Face</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <p>Please register 3-5 different angles of your face for better recognition:</p>
                        <ul>
                            <li>Front view</li>
                            <li>Left profile (30°)</li>
                            <li>Right profile (30°)</li>
                            <li>Looking slightly up</li>
                            <li>Looking slightly down</li>
                        </ul>
                    </div>
                    <div class="text-center mb-4">
                        <video id="video" width="640" height="480" autoplay></video>
                        <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
                    </div>
                    <div class="text-center">
                        <button id="capture" class="btn btn-primary">Capture</button>
                        <button id="done" class="btn btn-success" type="button" style="display:none;">Done</button>
                        <button id="register" class="btn btn-success" disabled>Register Face</button>
                        <button id="gotoLogin" class="btn btn-secondary" type="button" style="display:none;">Go to Login</button>
                        <button id="resetFace" class="btn btn-warning" type="button" style="display:none;">Reset Face Data</button>
                    </div>
                    <div id="status" class="mt-3 text-center"></div>
                    <div id="progress" class="mt-3">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">Captured: <span id="captureCount">0</span>/5</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let captureButton = document.getElementById('capture');
let registerButton = document.getElementById('register');
let statusDiv = document.getElementById('status');
let progressBar = document.querySelector('.progress-bar');
let captureCount = document.getElementById('captureCount');
let capturedImage = null;
let totalCaptures = 0;
const MAX_CAPTURES = 5;
const MIN_CAPTURES = 3;

// Add a JS variable for the user's email
const userEmail = '{{ request.user.email|escapejs }}';

// Access webcam
navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        video.srcObject = stream;
    })
    .catch(err => {
        console.error("Error accessing webcam:", err);
        statusDiv.innerHTML = "Error accessing webcam. Please ensure you have granted camera permissions.";
    });

// Capture image
captureButton.addEventListener('click', () => {
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    capturedImage = canvas.toDataURL('image/jpeg');
    registerButton.disabled = false;
    statusDiv.innerHTML = "Image captured! Click 'Register Face' to save.";
});

let doneButton = document.getElementById('done');
let gotoLoginButton = document.getElementById('gotoLogin');
let resetFaceButton = document.getElementById('resetFace');

// Register face
registerButton.addEventListener('click', () => {
    if (!capturedImage) return;

    statusDiv.innerHTML = "Registering face...";
    registerButton.disabled = true;
    captureButton.disabled = true;
    
    fetch('http://localhost:5001/api/face/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            image: capturedImage,
            email: userEmail
        })
    })
    .then(async response => {
        if (!response.ok) {
            const text = await response.text();
            let errorMsg = 'Unexpected error occurred.';
            if (text.startsWith('<')) {
                errorMsg = 'Server returned an HTML error page. You may not be authenticated on the Flask backend.';
            } else {
                try {
                    const data = JSON.parse(text);
                    errorMsg = data.error || errorMsg;
                } catch (e) {
                    errorMsg = text;
                }
            }
            throw new Error(errorMsg);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            statusDiv.innerHTML = `Error: ${data.error}`;
            registerButton.disabled = false;
            captureButton.disabled = false;
            // If max encodings error, disable all controls and show Go to Login and Reset Face Data
            if (data.error.includes('Maximum number of face encodings')) {
                captureButton.disabled = true;
                registerButton.disabled = true;
                doneButton.disabled = true;
                captureButton.style.display = 'none';
                registerButton.style.display = 'none';
                doneButton.style.display = 'none';
                gotoLoginButton.style.display = '';
                resetFaceButton.style.display = '';
            }
        } else {
            totalCaptures++;
            captureCount.textContent = totalCaptures;
            progressBar.style.width = `${(totalCaptures / MAX_CAPTURES) * 100}%`;
            
            if (totalCaptures >= MAX_CAPTURES) {
                statusDiv.innerHTML = "Maximum number of face captures reached! Redirecting to login...";
                setTimeout(() => {
                    window.location.href = '/accounts/login/';
                }, 2000);
            } else if (totalCaptures >= MIN_CAPTURES) {
                statusDiv.innerHTML = `Face registered successfully! You can capture ${MAX_CAPTURES - totalCaptures} more angles or click 'Done' to finish.`;
                doneButton.style.display = '';
                registerButton.disabled = false;
                captureButton.disabled = false;
            } else {
                statusDiv.innerHTML = `Face registered successfully! Please capture ${MIN_CAPTURES - totalCaptures} more angles.`;
                doneButton.style.display = 'none';
                registerButton.disabled = false;
                captureButton.disabled = false;
            }
            capturedImage = null;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `Error: ${error.message}`;
        registerButton.disabled = false;
        captureButton.disabled = false;
        // If max encodings error, disable all controls and show Go to Login and Reset Face Data
        if (error.message.includes('Maximum number of face encodings')) {
            captureButton.disabled = true;
            registerButton.disabled = true;
            doneButton.disabled = true;
            captureButton.style.display = 'none';
            registerButton.style.display = 'none';
            doneButton.style.display = 'none';
            gotoLoginButton.style.display = '';
            resetFaceButton.style.display = '';
        }
    });
});

doneButton.addEventListener('click', () => {
    window.location.href = '/accounts/login/';
});
gotoLoginButton.addEventListener('click', () => {
    window.location.href = '/accounts/login/';
});
resetFaceButton.addEventListener('click', () => {
    resetFaceButton.disabled = true;
    statusDiv.innerHTML = 'Resetting face data...';
    fetch('http://localhost:5001/api/face/reset', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: userEmail })
    })
    .then(async response => {
        if (!response.ok) {
            const text = await response.text();
            let errorMsg = 'Unexpected error occurred.';
            try {
                const data = JSON.parse(text);
                errorMsg = data.error || errorMsg;
            } catch (e) {
                errorMsg = text;
            }
            throw new Error(errorMsg);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            statusDiv.innerHTML = `Error: ${data.error}`;
            resetFaceButton.disabled = false;
        } else {
            statusDiv.innerHTML = 'Face data reset! Please reload the page to register again.';
            setTimeout(() => { window.location.reload(); }, 1200);
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `Error: ${error.message}`;
        resetFaceButton.disabled = false;
    });
});
</script>
{% endblock %} 