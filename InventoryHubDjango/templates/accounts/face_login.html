{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">Face Login</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <p>Please ensure:</p>
                        <ul>
                            <li>You are in a well-lit area</li>
                            <li>Your face is clearly visible</li>
                            <li>No other faces are in the frame</li>
                        </ul>
                    </div>
                    <div class="text-center mb-4">
                        <video id="video" width="640" height="480" autoplay></video>
                        <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
                    </div>
                    <div class="text-center">
                        <button id="capture" class="btn btn-primary">Capture</button>
                        <button id="login" class="btn btn-success" disabled>Login with Face</button>
                    </div>
                    <div id="status" class="mt-3 text-center"></div>
                    <div id="confidence" class="mt-3 text-center" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">Recognition Confidence: <span id="confidenceValue">0</span>%</small>
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'accounts:login' %}" class="btn btn-link">Login with Password Instead</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let captureButton = document.getElementById('capture');
let loginButton = document.getElementById('login');
let statusDiv = document.getElementById('status');
let confidenceDiv = document.getElementById('confidence');
let confidenceBar = document.querySelector('.progress-bar');
let confidenceValue = document.getElementById('confidenceValue');
let capturedImage = null;

// Access webcam
navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        video.srcObject = stream;
    })
    .catch(err => {
        console.error("Error accessing webcam:", err);
        statusDiv.innerHTML = "Error accessing webcam. Please ensure you have granted camera permissions.";
    });

// Capture image
captureButton.addEventListener('click', () => {
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    capturedImage = canvas.toDataURL('image/jpeg');
    loginButton.disabled = false;
    statusDiv.innerHTML = "Image captured! Click 'Login with Face' to continue.";
    confidenceDiv.style.display = 'none';
});

// Login with face
loginButton.addEventListener('click', () => {
    if (!capturedImage) return;

    statusDiv.innerHTML = "Verifying face...";
    loginButton.disabled = true;
    captureButton.disabled = true;
    
    fetch('http://localhost:5001/api/face/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            image: capturedImage
        })
    })
    .then(async response => {
        if (!response.ok) {
            const text = await response.text();
            let errorMsg = 'Unexpected error occurred.';
            if (text.startsWith('<')) {
                errorMsg = 'Server returned an HTML error page.';
            } else {
                try {
                    const data = JSON.parse(text);
                    errorMsg = data.error || errorMsg;
                } catch (e) {
                    errorMsg = text;
                }
            }
            throw new Error(errorMsg);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            statusDiv.innerHTML = `Error: ${data.error}`;
            loginButton.disabled = false;
            captureButton.disabled = false;
        } else {
            // Show confidence level
            confidenceDiv.style.display = 'block';
            const confidence = Math.round(data.confidence * 100);
            confidenceBar.style.width = `${confidence}%`;
            confidenceValue.textContent = confidence;
            
            statusDiv.innerHTML = "Face recognized! Logging you in...";
            
            // Send username/email to Django to log in
            fetch("{% url 'accounts:face_login_auth' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    username: data.user.username,
                    email: data.user.email
                })
            })
            .then(resp => resp.json())
            .then(authData => {
                if (authData.success) {
                    window.location.href = 'http://127.0.0.1:8000/';
                } else {
                    statusDiv.innerHTML = `Error: ${authData.error}`;
                    loginButton.disabled = false;
                    captureButton.disabled = false;
                }
            })
            .catch(err => {
                statusDiv.innerHTML = `Error: ${err.message}`;
                loginButton.disabled = false;
                captureButton.disabled = false;
            });
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `Error: ${error.message}`;
        loginButton.disabled = false;
        captureButton.disabled = false;
    });
});
</script>
{% endblock %} 